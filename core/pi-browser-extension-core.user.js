// ==UserScript==
// @name        pi-browser-extension-core
// @description Script to configurate Pi Apps inside Pi Browser iframe
// @version     1.3.0
// @namespace   https://github.com/pinetwork-js/pi-browser-extension
// @homepage    https://pinetwork-js.github.io/pi-browser-extension/core/
// @author      B-Derouet <brewal_derouet@hotmail.fr>
// @license     MIT
// @icon64      https://www.google.com/s2/favicons?sz=64&domain=minepi.com
// @match       https://app-cdn.minepi.com/*
// @noframes    
// @unwrap      
// @updateURL   https://pinetwork-js.github.io/pi-browser-extension/core/pi-browser-extension-core.meta.js
// @downloadURL https://pinetwork-js.github.io/pi-browser-extension/core/pi-browser-extension-core.user.js
// ==/UserScript==

(function(){"use strict";function h(t,e,i){const o=new MutationObserver((n,r)=>{for(const x of n)e(x,r)});return o.observe(t,{childList:!0,subtree:!0,...i}),()=>o.disconnect()}function g(t,e=document.documentElement){return new Promise(i=>{h(e,(o,n)=>{const r=e.querySelector(t);r&&(n.disconnect(),i(r))})})}function b(t){var e;(e=t.parentElement)==null||e.children[0].remove(),t.style.paddingLeft="0px"}const p=/^(?:pi|https):\/\/app-cdn\.minepi\.com\/mobile-app-ui\/app\/(.*?)(?:$|\/)/,s={brainstorm:"pi://brainstorm.pi",kyc:"pi://kyc.pi",devportal:"pi://develop.pi",translate:"pi://translate.pi","platform-demo-app":"pi://demo.pi",ecosystem:"pi://testnetecosystem.pi",chat:"pi://chat.pi",fireside:"pi://fireside.pinet.com"},c=/^(?:pi|https):\/\/app-cdn\.minepi\.com\/mobile-app-ui\/(.*?)(?:\?.*|$|\/)/,a={welcome:"pi://welcome.pi",chat:"pi://_LEGACY_chat.pi",wallet:"pi://wallet.pi",feed:"pi://mine.pi",error:"pi://error.pi"};function v(t){const e=t.replace("https://","pi://");if(p.test(e)){const[,i]=p.exec(e)??[];return i in s?s[i]:e}if(c.test(e)){const[,i]=c.exec(e)??[];return i in a?a[i]:a.feed}return e.startsWith("pi://blockexplorer.minepi.com/")||e.startsWith("pi://minepi.com/blockexplorer/")?"pi://blockchain.pi":e}function y(){const e=new URL(window.location.href).searchParams.get("url");return e?e.replace("pi://","https://"):a.welcome.replace("pi://","https://")}async function S(t){const e=localStorage.getItem("mobile-app-webview-ui_access-token");if(!e)return t;let i;try{i=new URL(t).hostname}catch{return`https://app-cdn.minepi.com/mobile-app-ui/error?url=${encodeURIComponent(t)}`}const n=await(await fetch(`https://socialchain.app/api/mobile_app/resolved_url?q=${i}`,{headers:{Authorization:e}}).catch()).json();return n.redirect_url?n.redirect_url.replace("http://","https://")+new URL(t).pathname:t}function l(t,e="replace"){const i=t?v(t):"";switch(e){case"push":{window.history.pushState({},"",`/browser?url=${i}`);break}case"pop":{window.history.back();break}case"replace":{window.history.replaceState({},"",`/browser?url=${i}`);break}}}function k(t){const{body:e}=new DOMParser().parseFromString(t,"text/html"),i=[...e.children];return i.length===1?i[0]:i}function _(t){const e=document.querySelector("iframe");e&&(e.src=t)}function U(t){t.addEventListener("load",()=>{var e;(e=t.contentWindow)==null||e.postMessage({type:"@pi:browser:init_navigation"})}),window.addEventListener("message",e=>{e.data.type==="@pi:browser:navigation_change"&&(e.data.payload.navigate&&_(e.data.payload.url),l(e.data.payload.url,e.data.payload.action))})}function L(t,e){const i=k(`<iframe src="${e}" allow="clipboard-read; clipboard-write; camera" style="width: 100vw; height: 100vh; border: none;"></iframe>`);U(i),t.append(i)}async function I(){const t=await g("main");b(t);const e=y(),i=await S(e);L(t,i);const o=p.test(i)?e:i;l(o)}const d={platform:{desktop:!0,os:"win32",version:"10.0.0",arch:"x64",uuid:"",hostApp:"pi-node"},bundleData:{versionNumber:"1.7.1",buildNumber:"26"},nativeSupport:{requestPermissions:!0,inlineMediaPlayback:!0}},u=structuredClone(d);u.platform.hostApp="pi-browser";const m=u;function w(t){localStorage.setItem("@pi:webview_ui_behaviors",JSON.stringify(t)),window.location.reload()}function f(){const t=localStorage.getItem("@pi:webview_ui_behaviors"),e=localStorage.getItem("mobile-app-webview-ui_access-token"),i=localStorage.getItem("@pi:logged-in");e&&t!==JSON.stringify(m)?w(m):!e&&!i&&(w(d),localStorage.setItem("@pi:logged-in","false"),window.location.href="https://app-cdn.minepi.com/mobile-app-ui/node-signin"),window.location.href!=="https://app-cdn.minepi.com/mobile-app-ui/node-signin"&&i==="false"&&(window.location.href="https://app-cdn.minepi.com/mobile-app-ui/node-signin"),e&&i==="false"&&(localStorage.setItem("@pi:logged-in","true"),window.location.href="https://app-cdn.minepi.com/browser"),window.location.href.startsWith("https://app-cdn.minepi.com/browser")&&I()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>f(),{once:!0}):f()})();
